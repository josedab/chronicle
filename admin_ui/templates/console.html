<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chronicle Query Console</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,sans-serif;background:#0f1117;color:#e6e8eb;display:flex;flex-direction:column;height:100vh}
header{background:#161b22;border-bottom:1px solid #30363d;padding:12px 24px;display:flex;align-items:center;gap:16px}
header h1{font-size:18px;font-weight:600;color:#58a6ff}
header .badge{background:#238636;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px}
.container{display:flex;flex:1;overflow:hidden}
.editor-panel{flex:1;display:flex;flex-direction:column;border-right:1px solid #30363d}
.results-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}
.toolbar{background:#161b22;padding:8px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #30363d}
.toolbar label{font-size:12px;color:#8b949e}
.toolbar select,.toolbar input{background:#0d1117;border:1px solid #30363d;color:#e6e8eb;padding:4px 8px;border-radius:4px;font-size:12px}
#query-editor{flex:1;background:#0d1117;border:none;color:#e6e8eb;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:14px;padding:16px;resize:none;outline:none;line-height:1.6}
#query-editor::placeholder{color:#484f58}
.btn{background:#238636;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500}
.btn:hover{background:#2ea043}
.btn-secondary{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
.btn-secondary:hover{background:#30363d}
.status-bar{background:#161b22;border-top:1px solid #30363d;padding:6px 16px;font-size:12px;color:#8b949e;display:flex;justify-content:space-between}
.results-table{overflow:auto;flex:1}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#161b22;position:sticky;top:0;padding:8px 12px;text-align:left;border-bottom:2px solid #30363d;color:#8b949e;font-weight:500}
td{padding:6px 12px;border-bottom:1px solid #21262d;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:12px}
tr:hover td{background:#161b22}
.chart-container{height:200px;padding:16px;border-bottom:1px solid #30363d;position:relative}
.chart-canvas{width:100%;height:100%}
.tab-bar{display:flex;gap:0;background:#0d1117}
.tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-size:13px;color:#8b949e}
.tab.active{color:#58a6ff;border-bottom-color:#58a6ff}
.error-msg{background:#3d1a1a;border:1px solid #6e3030;color:#f85149;padding:12px 16px;margin:8px;border-radius:6px;font-size:13px}
.empty-state{display:flex;align-items:center;justify-content:center;flex:1;color:#484f58;font-size:14px}
.history-item{padding:8px 16px;cursor:pointer;border-bottom:1px solid #21262d;font-size:12px;font-family:monospace}
.history-item:hover{background:#161b22}
.metrics-list{padding:16px;display:flex;flex-wrap:wrap;gap:8px}
.metric-tag{background:#21262d;padding:4px 10px;border-radius:12px;font-size:12px;cursor:pointer}
.metric-tag:hover{background:#30363d}
</style>
</head>
<body>
<header>
  <h1>üìä Chronicle Query Console</h1>
  <span class="badge">v1.0</span>
  <div style="flex:1"></div>
  <span id="conn-status" style="font-size:12px;color:#8b949e">Connected</span>
</header>
<div class="container">
  <div class="editor-panel">
    <div class="toolbar">
      <button class="btn" onclick="executeQuery()" title="Ctrl+Enter">‚ñ∂ Run</button>
      <button class="btn-secondary btn" onclick="clearEditor()">Clear</button>
      <div style="flex:1"></div>
      <label>Format:</label>
      <select id="format-select">
        <option value="table">Table</option>
        <option value="json">JSON</option>
        <option value="csv">CSV</option>
      </select>
    </div>
    <textarea id="query-editor" placeholder="Enter a CQL query...&#10;&#10;Examples:&#10;  SELECT * FROM cpu_usage WHERE host = 'prod-1' LAST 1h&#10;  SELECT avg(value) FROM temperature GROUP BY 1m&#10;  SHOW METRICS" spellcheck="false"></textarea>
  </div>
  <div class="results-panel">
    <div class="tab-bar">
      <div class="tab active" data-tab="results" onclick="switchTab('results')">Results</div>
      <div class="tab" data-tab="chart" onclick="switchTab('chart')">Chart</div>
      <div class="tab" data-tab="history" onclick="switchTab('history')">History</div>
      <div class="tab" data-tab="metrics" onclick="switchTab('metrics')">Metrics</div>
    </div>
    <div id="tab-results" class="results-table">
      <div class="empty-state">Run a query to see results</div>
    </div>
    <div id="tab-chart" class="chart-container" style="display:none">
      <canvas id="chart-canvas" class="chart-canvas"></canvas>
    </div>
    <div id="tab-history" style="display:none;overflow:auto;flex:1"></div>
    <div id="tab-metrics" style="display:none;overflow:auto;flex:1"></div>
  </div>
</div>
<div class="status-bar">
  <span id="status-text">Ready</span>
  <span id="status-timing"></span>
</div>
<script>
const history = [];
const editor = document.getElementById('query-editor');

editor.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); executeQuery(); }
});

async function executeQuery() {
  const query = editor.value.trim();
  if (!query) return;
  const start = performance.now();
  document.getElementById('status-text').textContent = 'Executing...';

  try {
    const resp = await fetch('/api/query', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query})
    });
    const data = await resp.json();
    const elapsed = (performance.now() - start).toFixed(1);

    if (data.error) {
      showError(data.error);
      document.getElementById('status-text').textContent = 'Error';
    } else {
      renderResults(data);
      document.getElementById('status-text').textContent =
        `${data.points ? data.points.length : 0} rows returned`;
      document.getElementById('status-timing').textContent = `${elapsed}ms`;
    }

    history.unshift({query, timestamp: new Date(), rows: data.points?.length || 0});
    if (history.length > 50) history.pop();
    renderHistory();
  } catch (err) {
    showError(err.message);
    document.getElementById('status-text').textContent = 'Connection error';
  }
}

function renderResults(data) {
  const panel = document.getElementById('tab-results');
  if (!data.points || data.points.length === 0) {
    panel.innerHTML = '<div class="empty-state">Query returned no results</div>';
    return;
  }

  const fmt = document.getElementById('format-select').value;
  if (fmt === 'json') {
    panel.innerHTML = `<pre style="padding:16px;font-size:12px;overflow:auto">${JSON.stringify(data.points, null, 2)}</pre>`;
    return;
  }

  const cols = ['metric', 'value', 'timestamp'];
  const tagKeys = new Set();
  data.points.forEach(p => { if (p.tags) Object.keys(p.tags).forEach(k => tagKeys.add(k)); });
  const allCols = [...cols, ...Array.from(tagKeys).sort()];

  let html = '<table><thead><tr>';
  allCols.forEach(c => html += `<th>${c}</th>`);
  html += '</tr></thead><tbody>';
  data.points.forEach(p => {
    html += '<tr>';
    html += `<td>${p.metric||''}</td>`;
    html += `<td>${p.value!=null?p.value.toFixed(4):''}</td>`;
    html += `<td>${p.timestamp?new Date(p.timestamp/1e6).toISOString():''}</td>`;
    tagKeys.forEach(k => html += `<td>${p.tags?.[k]||''}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  panel.innerHTML = html;

  renderChart(data.points);
}

function renderChart(points) {
  const canvas = document.getElementById('chart-canvas');
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width - 32;
  canvas.height = rect.height - 32;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (points.length < 2) return;

  const values = points.map(p => p.value).filter(v => v != null);
  if (values.length < 2) return;

  const min = Math.min(...values), max = Math.max(...values);
  const range = max - min || 1;
  const w = canvas.width, h = canvas.height;
  const pad = 40;

  ctx.strokeStyle = '#30363d';
  ctx.lineWidth = 1;
  for (let i = 0; i < 5; i++) {
    const y = pad + (h - 2 * pad) * i / 4;
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
    ctx.fillStyle = '#484f58';
    ctx.font = '10px system-ui';
    ctx.fillText((max - range * i / 4).toFixed(1), 2, y + 4);
  }

  ctx.strokeStyle = '#58a6ff';
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v, i) => {
    const x = pad + (w - 2 * pad) * i / (values.length - 1);
    const y = pad + (h - 2 * pad) * (1 - (v - min) / range);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

function showError(msg) {
  document.getElementById('tab-results').innerHTML = `<div class="error-msg">‚ùå ${msg}</div>`;
}

function clearEditor() { editor.value = ''; editor.focus(); }

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  ['results', 'chart', 'history', 'metrics'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === name ? '' : 'none';
  });
  if (name === 'metrics') loadMetrics();
}

function renderHistory() {
  const el = document.getElementById('tab-history');
  el.innerHTML = history.map(h =>
    `<div class="history-item" onclick="editor.value='${h.query.replace(/'/g,"\\'")}';switchTab('results')">
      <div>${h.query}</div>
      <div style="color:#484f58;margin-top:4px">${h.rows} rows ¬∑ ${h.timestamp.toLocaleTimeString()}</div>
    </div>`
  ).join('');
}

async function loadMetrics() {
  try {
    const resp = await fetch('/api/metrics');
    const data = await resp.json();
    const el = document.getElementById('tab-metrics');
    if (data.metrics && data.metrics.length > 0) {
      el.innerHTML = '<div class="metrics-list">' +
        data.metrics.map(m =>
          `<span class="metric-tag" onclick="editor.value='SELECT * FROM ${m} LAST 1h';switchTab('results');executeQuery()">${m}</span>`
        ).join('') + '</div>';
    } else {
      el.innerHTML = '<div class="empty-state">No metrics found</div>';
    }
  } catch (e) {
    document.getElementById('tab-metrics').innerHTML = '<div class="error-msg">Failed to load metrics</div>';
  }
}
</script>
</body>
</html>
